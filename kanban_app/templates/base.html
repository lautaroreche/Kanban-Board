{% load static %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kanban web">
    <meta name="keywords" content="kanban, kanban board, tablero kanban, tareas, tasks">
    <title>Kanboard</title>
    <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'styles/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
    {% block content %}{% endblock %}
    <script>
        const openBtn = document.getElementById('open-task-form');
        const closeBtn = document.getElementById('close-task-form');
        const panel = document.getElementById('task-form-panel');
    
        openBtn.addEventListener('click', () => {
            panel.classList.remove('translate-x-full');
            panel.classList.add('translate-x-0');
        });
    
        closeBtn.addEventListener('click', () => {
            panel.classList.add('translate-x-full');
        });
    </script>
    <script>
        function fillTaskForm(el) {
            const panel = document.getElementById('task-form-panel');
            const form = document.getElementById('task-form');

            panel.classList.remove('translate-x-full');
            panel.classList.add('translate-x-0');

            const taskId = el.dataset.taskId;
            const title = el.dataset.taskTitle;
            const detail = el.dataset.taskDetail;
            const priority = el.dataset.taskPriority;
            const status = el.dataset.taskStatus;

            form.action = `/edit/${taskId}/`;
            document.querySelector('#task-id').value = taskId;
            form.title.value = title;
            try {
                form.detail.value = JSON.parse('"' + detail.replace(/"/g, '\\"') + '"');
            } catch (e) {
                form.detail.value = detail;
            }
            form.priority.value = priority;
            form.status.value = status;

            const button = form.querySelector('button[type="submit"]');
            button.textContent = 'Save Task';

            document.querySelector('#task-form-panel h2').textContent = 'Edit Task';
        }
    </script>
    <script>
        const deletePanel = document.getElementById('delete-confirmation-panel');
        const confirmDeleteLink = document.getElementById('confirm-delete-link');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
    
        function openDeletePanel(taskId) {
            deletePanel.classList.remove('translate-x-full');
            deletePanel.classList.add('translate-x-0');
    
            confirmDeleteLink.href = `/delete/${taskId}/`;
        }
    
        cancelDeleteBtn.addEventListener('click', () => {
            deletePanel.classList.add('translate-x-full');
        });
    </script>
    <script>
        document.querySelectorAll('.task-column').forEach(column => {
            new Sortable(column, {
                group: 'kanban-columns',
                animation: 150,
                onEnd: function (evt) {
                    const taskElement = evt.item;
                    const taskId = taskElement.dataset.taskId;
                    const oldStatus = taskElement.dataset.status;
                    const newStatus = evt.to.id.replace('-column', '');
    
                    if (oldStatus === newStatus) {
                        return;
                    }
    
                    fetch(`/modify_status/${taskId}/${newStatus}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            console.error('Error al mover la tarea');
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
